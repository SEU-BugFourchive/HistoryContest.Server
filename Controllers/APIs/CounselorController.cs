using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;
using HistoryContest.Server.Models;
using HistoryContest.Server.Models.ViewModels;
using HistoryContest.Server.Data;
using System.IO;
using OfficeOpenXml;
using Microsoft.AspNetCore.Hosting;

namespace HistoryContest.Server.Controllers.APIs
{
    [Authorize(Roles = "Counselor, Administrator")]
    [Produces("application/json")]
    [Route("api/[controller]")]
    public class CounselorController : Controller
    {
        private readonly UnitOfWork unitOfWork;
        private IHostingEnvironment hostingEnvironment;

        public CounselorController(UnitOfWork unitOfWork, IHostingEnvironment hostingEnvironment)
        {
            this.unitOfWork = unitOfWork;
            this.hostingEnvironment = hostingEnvironment;
            unitOfWork.StudentRepository.LoadStudentsFromCounselors();
        }
        
        /// <summary>
        /// 下载当前辅导员所在院系所有学生分数情况的EXCEL表
        /// </summary>
        /// <remarks>
        ///     无参数
        ///     尚未测试
        /// </remarks>
        /// <returns>院系学生EXCEL</returns>
        /// <response code="200">返回本院系得分EXCEL</response>
        [HttpGet("xlsx")]
        public async Task<IActionResult> Export()
        {
            string sWebRootFolder = hostingEnvironment.WebRootPath;
            string sFileName = "123321.xlsx";

            // TODO : 改成从session中获取DepartmentID
            var counselorid = int.Parse(HttpContext.Session.GetString("id"));
            var id = (unitOfWork.CounselorRepository.GetByID(counselorid)).Department;

            var datatable=(await unitOfWork.StudentRepository.GetByDepartment(id)).AsQueryable().Select(s => (StudentViewModel)s);
            FileInfo file = new FileInfo(Path.Combine(sWebRootFolder, sFileName));
            using (ExcelPackage package = new ExcelPackage(file))
            {
                // 添加worksheet
                ExcelWorksheet worksheet = package.Workbook.Worksheets.Add("aspnetcore");
                //添加头
                worksheet.Cells[1, 1].Value = "学号";
                worksheet.Cells[1, 2].Value = "一卡通号";
                worksheet.Cells[1, 3].Value = "姓名";
                worksheet.Cells[1, 4].Value = "是否完成";
                worksheet.Cells[1, 5].Value = "得分";
                //添加值
                int number = 2;
                foreach(var student in datatable)
                {
                    worksheet.Cells[number, 1].Value = student.StudentID;
                    worksheet.Cells[number, 2].Value = student.CardID;
                    worksheet.Cells[number, 3].Value = student.Name;
                    worksheet.Cells[number, 4].Value = student.IsCompleted?"是":"否";
                    worksheet.Cells[number, 5].Value = student.Score;
                    number++;
                }
                
                package.Save();
            }
            return File(sFileName, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        }

        /// <summary>
        /// 获取辅导员所在院系
        /// </summary>
        /// <remarks>
        /// 返回Session中存储的院系代号。
        /// </remarks>
        /// <returns>辅导员对应院系代号</returns>
        /// <response code="200">返回辅导员所在的院系代号</response>
        /// <response code="404">Session中未设置院系代号</response>
        [HttpGet("Department")]
        [ProducesResponseType(typeof(Department), StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public IActionResult GetDepartment()
        {
            var id = HttpContext.Session.GetInt32("department");
            if (id == null)
            {
                return NotFound();
            }
            return Json((Department)id);
        }

        /// <summary>
        /// 获取一个院系所有学生的学号
        /// </summary>
        /// <remarks>
        /// 这个API将辅导员对应的所有学生的学号返回，让前端根据学号一个个地检索学生信息。可能在异步加载上有所帮助。
        /// 
        /// ID参数是可选的。如果不输入ID，且当前用户认证为辅导员，则取Session中的院系代码作为ID。
        /// </remarks>
        /// <param name="id">院系代号枚举数（可选）</param>
        /// <returns>院系所有学生学号</returns>
        /// <response code="200">返回辅导员对应的所有学生学号构成的数组</response>
        /// <response code="400">当前用户不是辅导员或对应Session中没有院系代码</response>
        /// <response code="403">辅导员查询非本系数据</response>
        /// <response code="404">ID不属于任何一个院系代号</response>
        [HttpGet("AllStudents/{id?}")]
        [ProducesResponseType(typeof(IEnumerable<int>), StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        [ProducesResponseType(StatusCodes.Status403Forbidden)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> AllStudentIDs(Department? id)
        {
            if (id == null && HttpContext.User.IsInRole("Counselor") && HttpContext.Session.Get("department") != null)
            { // 如果不输入ID，且当前用户认证为辅导员，则取Session中的院系代码作为ID
                id = (Department)HttpContext.Session.GetInt32("department");
            }
            else
            {
                return BadRequest("Empty argument request invalid");
            }

            if (!HttpContext.User.IsInRole("Administrator") && id != (Department)HttpContext.Session.GetInt32("department"))
            { // 不允许辅导员查询不同系学生的数据
                return Forbid();
            }

            var students = (await unitOfWork.StudentRepository.GetByDepartment((Department)id));
            if (students == null)
            {
                return NotFound();
            }

            return Json(students.AsQueryable().Select(s => s.ID));
        }

        #region Scores APIs
        /// <summary>
        /// 获取一个院系所有学生的简要得分信息
        /// </summary>
        /// <remarks>
        /// ID参数是可选的。如果不输入ID，且当前用户认证为辅导员，则取Session中的院系代码作为ID。
        /// </remarks>
        /// <param name="id">院系代号枚举数（可选）</param>
        /// <returns>院系所有学生得分</returns>
        /// <response code="200">返回本院系所有学生简要得分信息</response>
        /// <response code="400">当前用户不是辅导员或对应Session中没有院系代码</response>
        /// <response code="403">辅导员查询非本系数据</response>
        /// <response code="404">ID不属于任何一个院系代号</response>
        [HttpGet("Scores/All/{id?}")]
        [ProducesResponseType(typeof(IEnumerable<StudentViewModel>), StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        [ProducesResponseType(StatusCodes.Status403Forbidden)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> AllScoresByDepartment(Department? id)
        {
            if (id == null && HttpContext.User.IsInRole("Counselor") && HttpContext.Session.Get("department") != null)
            { // 如果不输入ID，且当前用户认证为辅导员，则取Session中的院系代码作为ID
                id = (Department)HttpContext.Session.GetInt32("department");
            }
            else
            {
                return BadRequest("Empty argument request invalid");
            }

            if (!HttpContext.User.IsInRole("Administrator") && id != (Department)HttpContext.Session.GetInt32("department"))
            { // 不允许辅导员查询不同系学生的数据
                return Forbid();
            }

            var students = (await unitOfWork.StudentRepository.GetByDepartment((Department)id));
            if (students == null)
            {
                return NotFound();
            }

            return Json(students.AsQueryable().Select(s => (StudentViewModel)s));
        }

        /// <summary>
        /// 获取一个学生的简要得分信息
        /// </summary>
        /// <remarks>
        /// 这个API主要是配合 `POST api/Counselor/AllStudents/{id}` 使用，使前端能够先获得学号，然后根据学号分批分次地加载学生信息。
        /// </remarks>
        /// <returns>学生简要得分信息</returns>
        /// <param name="id">学生的学号</param>
        /// <response code="200">返回学号对应学生的得分信息</response>
        /// <response code="403">辅导员查询非本系学生的数据</response>
        /// <response code="404">ID没有对应的学生</response>
        [HttpGet("Scores/Single/{id}")]
        [ProducesResponseType(typeof(StudentViewModel), StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status403Forbidden)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> StudentScoreById(int id)
        {
            var student = await unitOfWork.StudentRepository.GetByIDAsync(id);
            if (student == null)
            {
                return NotFound();
            }

            if (!HttpContext.User.IsInRole("Administrator") && student.CounselorID != int.Parse(HttpContext.Session.GetString("id")))
            { // 不允许辅导员查询不同系学生的数据
                return Forbid();
            }

            return Json((StudentViewModel)student);
        }
        #endregion

        #region Score Summary APIs
        /// <summary>
        /// 获取全校分数概况
        /// </summary>
        /// <remarks>
        /// **NOTE:这个功能目前尚未被正确实现，仅用于参考JSON返回值**
        /// </remarks>
        /// <returns>全校分数概况</returns>
        /// <response code="200">
        /// 返回全校的分数概况及学生完成情况
        /// * 这个内容并不是每次请求时新计算而得的，而是每隔一段时间（如10分钟）自动更新一次
        /// * 因此，JSON文件里面有一个“更新时间”的记录。
        /// </response>
        [HttpGet("Scores/Summary")]
        [ProducesResponseType(typeof(ScoreSummaryOfSchoolViewModel), StatusCodes.Status200OK)]
        public async Task<IActionResult> ScoreSummaryOfSchool()
        {
            // TODO: 全校的Score Summary来自/放入缓存, 及正确实现获取全校概况
            var model = new ScoreSummaryOfSchoolViewModel
            {
                MaxScore = await unitOfWork.StudentRepository.HighestScore(),
                AverageScore = await unitOfWork.StudentRepository.AverageScore(),
                ScoreBandCount =
                {
                    HigherThan90 = await unitOfWork.StudentRepository.ScoreHigherThan(90),
                    HigherThan75 = await unitOfWork.StudentRepository.ScoreHigherThan(75),
                    HigherThan60 = await unitOfWork.StudentRepository.ScoreHigherThan(60)
                },
                UpdateTime = DateTime.Now
            };
            model.ScoreBandCount.Failed = await unitOfWork.StudentRepository.SizeAsync() - model.ScoreBandCount.HigherThan60;
            return Json(model);
        }

        /// <summary>
        /// 获取一个院系的分数概况
        /// </summary>
        /// <remarks>
        /// 院系代号在后端为一个枚举，目前内容如下：
        ///     
        ///     enum Department
        ///     {
        ///         建筑 = 0x010,
        ///         计算机 = 0x090
        ///     }
        /// 
        /// 前端也可建立一个相同的枚举表，这样便可不用在意每个枚举值中所存数据。
        /// 
        /// ID参数是可选的。如果不输入ID，且当前用户认证为辅导员，则取Session中的院系代码作为ID。
        /// </remarks>
        /// <param name="id">院系代号枚举数（可选）</param>
        /// <returns>ID对应院系的分数概况</returns>
        /// <response code="200">返回院系代码对应院系的分数概况</response>
        /// <response code="400">当前用户不是辅导员或对应Session中没有院系代码</response>
        /// <response code="404">ID没有对应的院系</response>
        [HttpGet("Scores/Summary/{id?}")]
        [ProducesResponseType(typeof(ScoreSummaryByDepartmentViewModel), StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> ScoreSummaryByDepartment(Department? id)
        {
            if (id == null && HttpContext.User.IsInRole("Counselor") && HttpContext.Session.Get("department") != null)
            { // 如果不输入ID，且当前用户认证为辅导员，则取Session中的院系代码作为ID
                id = (Department)HttpContext.Session.GetInt32("department");
            }
            else
            {
                return BadRequest("Empty argument request invalid");
            }

            var counselor = await unitOfWork.CounselorRepository.FirstOrDefaultAsync(c => c.Department == id);
            if (counselor == null)
            {
                return NotFound();
            }

            // TODO: Score Summary放入缓存
            var model = new ScoreSummaryByDepartmentViewModel
            {
                DepartmentID = counselor.Department,
                CounselorName = counselor.Name,
                MaxScore = await unitOfWork.StudentRepository.HighestScoreByDepartment(counselor.Department),
                AverageScore = await unitOfWork.StudentRepository.AverageScoreByDepartment(counselor.Department),
                ScoreBandCount =
                {
                    HigherThan90 = await unitOfWork.StudentRepository.ScoreHigherThanByDepartment(90, counselor.Department),
                    HigherThan75 = await unitOfWork.StudentRepository.ScoreHigherThanByDepartment(75, counselor.Department),
                    HigherThan60 = await unitOfWork.StudentRepository.ScoreHigherThanByDepartment(60, counselor.Department)
                }
            };
            model.ScoreBandCount.Failed = await unitOfWork.StudentRepository.SizeByDepartment(counselor.Department) - model.ScoreBandCount.HigherThan60;
            return Json(model);
        }
        #endregion
    }
}
